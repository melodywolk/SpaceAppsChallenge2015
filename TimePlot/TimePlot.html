<!DOCTYPE HTML>
<html>
	<head>
      <style>
			body {
				margin: 0px;
				padding: 0px;
			}
      </style>
   </head>
   <body>
		<input type="file" id="files" name="files[]" multiple />

		<script>
		   /*
		    * define the runAnimation boolean as an obect
		    * so that it can be modified by reference
		    */
			var runAnimation = {
				value: false,
				loading: false,
				progress: '.'
			};
			var wasLoading = false;
		
		   // read in data from file
		   var fileJSON;
		   runAnimation.loading = true;
		   var reader = new FileReader();
			reader.onload = function(event) {
				var contents = event.target.result;
				// convert text to JSON object
				neo = JSON.parse(contents);
				neoMax = neo.length - 1;
				initXYPos();
				initDistance();
				// Need function to find min and max date? initDate();
				var dateMaxIdx = neo[0].data.length - 1;
				dateMin = neo[0].data[0][0];
				dateMax = neo[0].data[dateMaxIdx][0];
				dateN = dateMax - dateMin + 1;
				dTheta = 2*Math.PI / (dateN/dDate);
				runAnimation.loading = false;
				console.log("File contents: " + contents);
			};
		
		   reader.onerror = function(event) {
				console.error("File could not be read! Code " + event.target.error.code);
				runAnimation.loading = false;
			};
		
			function initDistance() {
				distMax = 12;
				scaleDist = 290 / distMax;
			}	  
		
		   function handleFileSelect(evt) {
		      var files = evt.target.files; // FileList object
		
		      // files is a FileList of File objects. List some properties.
		      if(files.length) {
				   fileJSON = files[0];
				   reader.readAsText(fileJSON);
		      }
		   }
		
		   document.getElementById('files').addEventListener('change', handleFileSelect, false);
		</script>
		<h3>
		   <a href="https://github.com/melodywolk/SpaceAppsChallenge2015">IfA SpaceAppsChallenge2015</a>
		</h3>
		<canvas id="myCanvas" width="600" height="600"></canvas>
		<script>
			window.requestAnimFrame = (function(callback) {
				return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
				function(callback) {
					window.setTimeout(callback, 1000 / 60);
				};
			})();
		
			function initXYPos() {
				for(var n=0; n <= neoMax; n++) {
					xyPos[n] = {x:0,y:0,dataIdx:0};
				}
			}
		
		      /* NEO data JSON structure - serge
		      name
		      H
		      uncertainty
		      mjds[]
		      distances[]
		      jplurl
		      impactprobability
		      vinifinity
		      jplH
		      jplDiameter
		      palermoScaleCum
		      palermoScaleMax
		
		      */
		      /* NEO data JSON structure - larry
		      name
				palermo
				diam_km
				data [2] (mjds,dist_AU)
		      */
		
			function drawMoon(context) {
				context.save();
				var x = canvas.width / 2;
				var y = canvas.height / 2;
				var radius = 5.58478337899650 * scaleDist;
				var startAngle = 0 * Math.PI;
				var endAngle = 2 * Math.PI;
				var counterClockwise = false;
	
				context.beginPath();
				context.setLineDash([3]);
				context.arc(x, y, radius, startAngle, endAngle, counterClockwise);
				context.lineWidth = 2;
				// line color
				context.strokeStyle = 'white';
				context.stroke();
				context.restore();
			}
		
			function drawGEO(context) {
				context.save();
				var x = canvas.width / 2;
				var y = canvas.height / 2;
				var radius = 4.55371315759617 * scaleDist;
				var startAngle = 0 * Math.PI;
				var endAngle = 2 * Math.PI;
				var counterClockwise = false;
	
				context.beginPath();
				context.setLineDash([6,3]);
				context.arc(x, y, radius, startAngle, endAngle, counterClockwise);
				context.lineWidth = 2;
				// line color
				context.strokeStyle = '#c7c7c7';
				context.stroke();
				context.restore();
			}
		
			function colorScale(value) {
				// Red -2
				// Orange -4
				// Yellow -6
				// Green -8
				// Blue < -8
				if(value >= -2.0)
					return 'red';
				if(value >= -4.0)
					return 'orange';
				if(value >= -6.0)
					return 'yellow';
				if(value >= -8.0)
					return 'green';
				return 'blue';
				/*
				var a = 0.7; 
				value *= -255*255*5;
				var r = value;
				r >>= 4;
				r %= 256;
				var g = value;
				g >>= 2;
				g %= 256;
				var b = value;
				b %= 24;
				b = 0;
				return "rgba("+r+","+g+","+b+","+a+")";
				*/
			}
		
			function drawObject(obj, context) {
				// compute x,y as function of time and dist from center

				// if the current dateIdx is equal to the current object's current data element's date
				// then plot the position and increment the dataIdx of the object
				var dist = -1;
				var dataIdx = xyPos[neoIdx].dataIdx;
				if(neo[neoIdx].data[dataIdx][0] == dateMin+dateIdx) {
					dist = neo[neoIdx].data[dataIdx][1];
					// convert AU to log10(km)
					// using 149597871 km / AU
					dist *= 149597871.0;
					dist = Math.log10(dist);
					xyPos[neoIdx].dataIdx++;
				}
				if(dist >= 0) {
					var x = dist * scaleDist;
					x = x * Math.cos(theta);
					x = x + canvas.width/2;
					var y = dist * scaleDist;
					y = y * Math.sin(theta);
					y = y + canvas.height/2;
					if(x >= 0 && x < canvas.width && y >= 0 && y < canvas.height) {
						if(dateIdx == 0) {
							xyPos[neoIdx].x = x;
							xyPos[neoIdx].y = y;
						}
						context.beginPath();
						context.moveTo(x,y);
						context.lineTo(xyPos[neoIdx].x, xyPos[neoIdx].y);
						context.lineWidth = 2; //obj.H * scaleH;
						// set line color based on danger
						context.strokeStyle = colorScale(obj.palermo);
						context.stroke();
						xyPos[neoIdx].x = x;
						xyPos[neoIdx].y = y;
					}
				}
			}
		
			function animate(neo, runAnimation, canvas, context) {
				if(runAnimation.value) {
					// this code breaks if there are NO OBJECTS!!!!
					// draw the object
					if(runAnimation.loading) {
						context.font = 'italic 40pt Calibri';
						var str = 'Loading ';
						var prog = runAnimation.progress;
						context.fillText(str.concat(prog), 0, canvas.height-20);
						// slow to one dot / sec
						if(++calls % 100 == 0) { 
							runAnimation.progress = prog.concat('.');
						}
						wasLoading = true;
					}
					else
					{
						if(wasLoading)  {
							wasLoading = false;
		
							context.clearRect(0, 0, canvas.width, canvas.height);
							context.drawImage(bgImage, (canvas.width-bgImage.width)/2, (canvas.height-bgImage.height)/2);
							drawMoon(context);
							drawGEO(context);
						}
						drawObject(neo[neoIdx], context);
						// select the "next" object and date
						neoIdx = neoIdx + 1;
						if(neoIdx > neoMax) {
							neoIdx = 0;
							dateIdx = dateIdx + dDate;
							theta += dTheta;
							if(dateIdx > dateN) {
								// end the animation after drawing all objects for all dates
								dateIdx = 0;
								theta = 0;
								runAnimation.value = false;
							}
						}
					}
		
					if(runAnimation.value) {
						// request new frame
						requestAnimFrame(function() {
						animate(neo, runAnimation, canvas, context);
						});
		
					}
				}
			}
		
			var canvas = document.getElementById('myCanvas');
			var context = canvas.getContext('2d');
			var theta = 0;
			var neo = [];
			var neoIdx = 0; 
			var neoMax = -1;
			var dateIdx = 0;
			var dateN = -1;
			var dateMin = -1;
			var dateMax = -1;
			var dTheta = 0;
			var dDate = 1; // plot every 30 days - need to check 2nd derivative per object instead
			var xyPos = [];
			var distMax = 12;
			var scaleDist = 290 / distMax;
			var scaleH = 0.2;
			var scalePalermo = -300000;
			var calls = 0;
		
			var bgImage = new Image();
		
			bgImage.onload = function() {
				context.drawImage(bgImage, (canvas.width-bgImage.width)/2, (canvas.height-bgImage.height)/2);
				drawMoon(context);
				drawGEO(context);
			};
		   bgImage.src = 'http://apod.nasa.gov/apod/image/1210/m8m20_panstarrs900.jpg';
		
		      
		   // add click listener to canvas
			document.getElementById('myCanvas').addEventListener('click', function() {
				// flip flag
				runAnimation.value = !runAnimation.value;
		
				if(runAnimation.value) {
					// clear the canvas
					context.clearRect(0, 0, canvas.width, canvas.height);
					context.drawImage(bgImage, (canvas.width-bgImage.width)/2, (canvas.height-bgImage.height)/2);
					drawMoon(context);
					drawGEO(context);
					// reset the animation
					neoIdx = 0;
					dateIdx = 0;
					theta = 0;
					animate(neo, runAnimation, canvas, context);
				}
			});
		</script>
   </body>
</html>      
